from aiogram import Bot, Router, F
from aiogram.types import CallbackQuery

from handlers.function import download_and_send_media
import url_storage as storage
import handlers.commands as hc

router = Router()

@router.callback_query(lambda callback: 'video' in callback.data or 'audio' in callback.data)
async def format_selection(callback: CallbackQuery, bot: Bot):
    storage.url_storage = storage.load_url_storage()
    action, url_id = callback.data.split("|")
    url = storage.url_storage.get(url_id)
    #loading_msg = await callback.message.answer("–ó–∞–±–∏—Ä–∞—é –∫ —Å–µ–±–µ –≤–∏–¥–µ–æ...")

    if not url:
        await callback.answer("–ß–µ—Ç —Ç—ã –Ω–µ URL –∞–¥—Ä–µ—Å –∫–∏–Ω—É–ª....")
        return
    await callback.answer("–©–∞—Å –±—ã—Å—Ç—Ä–µ–Ω—å–∫–∞ —Å–∫–∞—á–∞—é –≤–∏–¥–µ–æ...üêò")
    if action == 'video':
       await callback.message.edit_reply_markup(reply_markup=None)
       await callback.message.delete()
       loading_msg =  await callback.message.answer("–ó–∞–±–∏—Ä–∞—é –∫ —Å–µ–±–µ –≤–∏–¥–µ–æ...")
       await download_and_send_media(bot, callback.message.chat.id, url, media_type='video')
       await loading_msg.delete()

    elif action == 'audio':
        await callback.message.edit_reply_markup(reply_markup=None)
        await callback.message.delete()
        loading_msg = await callback.message.answer("–ó–∞–±–∏—Ä–∞—é –∫ —Å–µ–±–µ  –∞—É–¥–∏–æ...")
        await download_and_send_media(bot, callback.message.chat.id, url, media_type='audio')
        await loading_msg.delete()

